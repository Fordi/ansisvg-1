{{- /*
Tries to generate SVG code comptible with browers and inkscape.
For some reason inkscape seesm to not like CSS for rect fill etc that much
so currently using <use> instead.
*/ -}}
{{- $width := mul $.TerminalWidth .CharacterBoxSize.Width -}}
{{- $height := mul $.Lines .CharacterBoxSize.Height -}}
<svg viewBox="0 0 {{$width}} {{$height}}" width="{{$width}}" height="{{$height}}" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <style>
        rect {
            shape-rendering: crispEdges;
        }
        text {
            dominant-baseline: text-before-edge;
            white-space: pre;{{/* draw underline even when whitespace */}}
            font: {{$.FontSize}}px {{$.FontName}};
            fill: {{index $.ForegroundColors "0"}};
        }
        .u { text-decoration: underline; }
    </style>
    <svg style="display: none">
{{- range $i, $c := $.BackgroundColors}}
{{- if ne $c ""}}
        <rect id="b{{$i}}" width="{{$.CharacterBoxSize.Width}}" height="{{$.CharacterBoxSize.Height}}" stroke-width="1px" stroke="{{$c}}" style="fill: {{$c}}"/>
{{- end}}
{{- end}}
    </svg>
{{- if not .Transparent}}
    <rect width="100%" height="100%" x="0" y="0" style="fill: {{index $.BackgroundColors "0"}}"/>
{{- end}}
{{- range $i, $c := .Chars}}
    {{- if le $c.X $.TerminalWidth}}
        {{- if hasprefix $c.Background "#"}}
    <use xlink:href="#b0" x="{{mul $c.X $.CharacterBox.Width}}" y="{{mul $c.Y $.CharacterBoxSize.Height}}" stroke="{{$c.Background}}" style="fill: {{$c.Background}}"/>
        {{- else if ne $c.Background "0"}}
    <use xlink:href="#b{{$c.Background}}" x="{{mul $c.X $.CharacterBoxSize.Width}}" y="{{mul $c.Y $.CharacterBoxSize.Height}}"/>
        {{- end}}
    {{- end}}
{{- end}}
{{- range $i, $c := .Chars}}
    {{- if le $c.X $.TerminalWidth}}
        {{- if or $c.Underline (not (iswhitespace $c.Char))}}
            {{- $x := mul $c.X $.CharacterBoxSize.Width}}
            {{- $y := mul $c.Y $.CharacterBoxSize.Height}}
            {{- $color := ""}}
            {{- if hasprefix $c.Foreground "#"}}
                {{- $color = $c.Foreground}}
            {{- else if or (ne $c.Foreground "0") $c.Intensity}}
                {{- $color = index $.ForegroundColors $c.Foreground}}
            {{- end}}
            {{- if $c.Intensity}}
                {{- $color = coloradd $color "#505050"}}
            {{- end}}
            {{- if ne $color ""}}
    <text x="{{$x}}" y="{{$y}}" style="fill: {{$color}}" class="{{if $c.Underline}}u{{end}}">{{$c.Char}}</text>
            {{- else}}
    <text x="{{$x}}" y="{{$y}}">{{$c.Char}}</text>
            {{- end}}
        {{- end}}
    {{- end}}
{{- end}}
</svg>
